<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self';">
  
  <title>AppAudit: Guardian</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root { --accent: #ff9f43; --bg: #0f0f0f; --panel: #1e1e1e; --text: #eee; --success: #1dd1a1; --warn: #feca57; --error: #ff6b6b; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
    header { padding: 15px 25px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 18px; color: var(--accent); letter-spacing: 1px; }
    #container { flex: 1; overflow-y: auto; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; }
    .section { display: flex; flex-direction: column; gap: 12px; animation: fadeIn 0.3s ease; }
    .hidden { display: none !important; }
    textarea, #fix-result { background: #161616; color: #dcdcdc; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: 'Consolas', monospace; font-size: 13px; min-height: 400px; width: 100%; box-sizing: border-box; outline: none; line-height: 1.5; }
    #fix-result { white-space: pre; overflow-x: auto; color: #a29bfe; border: 1px solid var(--accent); }
    .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: #333; color: white; }
    #status-deck { display: none; background: #000; border: 1px solid var(--accent); border-radius: 8px; padding: 30px; text-align: center; font-family: monospace; }
    .issue-card { background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 10px; text-align: left; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<header>
    <h1>AppAudit <span style="font-size:10px; opacity:0.7;">GUARDIAN</span></h1>
    <div style="font-size: 10px; color: var(--success); font-weight: bold;">‚óè PROTECTED_MODE</div>
</header>

<div id="container">
    <div id="sec-input" class="section">
        <label style="color: #888; font-weight: bold;">[01] SOURCE_CODE_INPUT</label>
        <textarea id="code-in" placeholder="// Paste code here for secure audit..."></textarea>
        <div style="display: flex; gap: 10px;">
            <button onclick="startAnalysis()" class="btn btn-primary" style="flex: 2;">üîç SECURE ANALYZE</button>
            <button onclick="forceErase()" class="btn btn-secondary" style="flex: 1;">üóëÔ∏è ERASE</button>
        </div>
    </div>

    <div id="status-deck"></div>

    <div id="sec-list" class="section hidden">
        <label style="color: #888; font-weight: bold;">[02] ISSUES_DETECTED</label>
        <div id="issue-list"></div>
        <button onclick="fixIssues()" id="btn-fix" class="btn btn-primary">‚ú® APPLY PRECISION PATCHES</button>
        <button onclick="softReset()" style="background:none; border:none; color:#888; cursor:pointer; margin-top: 10px;">‚Üê BACK</button>
    </div>

    <div id="sec-result" class="section hidden">
        <label style="color: #888; font-weight: bold;">[03] PATCHED_CODE</label>
        <div id="fix-result"></div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="copyCode()" class="btn btn-primary" style="flex: 1;">üìã COPY PATCHED CODE</button>
            <button onclick="softReset()" class="btn btn-secondary" style="flex: 1;">NEW AUDIT</button>
        </div>
    </div>
</div>

<script>
let currentCode = "";

function softReset() {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.getElementById('sec-input').classList.remove('hidden');
    document.getElementById('status-deck').style.display = 'none';
    document.getElementById('issue-list').innerHTML = "";
    document.getElementById('fix-result').innerText = "";
}

function forceErase() {
    document.getElementById('code-in').value = "";
    document.getElementById('code-in').focus();
}

function copyCode() {
    const text = document.getElementById('fix-result').innerText;
    navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard."));
}

/** * SECURE PROXY CALL 
 */
async function callProxy(task, code) {
    try {
        const response = await fetch('/api/audit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task, code })
        });
        
        if (!response.ok) throw new Error("Security Proxy Refused Connection.");
        
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    } catch (e) {
        console.error("System Log:", e.message); // Hidden from UI
        alert("Guardian Alert: Secure connection failed.");
        throw e;
    }
}

async function startAnalysis() {
    currentCode = document.getElementById('code-in').value;
    if(!currentCode) return;
    
    document.getElementById('sec-input').classList.add('hidden');
    const status = document.getElementById('status-deck');
    status.style.display = 'block';
    status.innerText = "> AUDITING VIA SECURE PROXY...";

    try {
        const text = await callProxy('audit', currentCode);
        const jsonMatch = text.match(/\[\s*[\s\S]*\s*\]/);
        if(!jsonMatch) throw new Error("Invalid format");

        const issues = JSON.parse(jsonMatch[0]);
        status.style.display = 'none';
        document.getElementById('sec-list').classList.remove('hidden');
        document.getElementById('issue-list').innerHTML = issues.map(i => `
            <div class="issue-card">
                <b style="color:var(--accent)">${i.title}</b><br>
                <small style="color:#aaa">${i.desc}</small>
            </div>`).join('');
    } catch(e) { softReset(); }
}

async function fixIssues() {
    const btn = document.getElementById('btn-fix');
    btn.innerText = "PATCHING...";
    btn.disabled = true;

    try {
        let res = await callProxy('fix', currentCode);
        let fixedCode = res.replace(/^```[a-z]*\n/i, '').replace(/\n```$/i, '').trim();
        
        document.getElementById('fix-result').innerText = fixedCode;
        document.getElementById('sec-list').classList.add('hidden');
        document.getElementById('sec-result').classList.remove('hidden');
    } catch(e) { btn.disabled = false; }
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>
</body>
</html>