<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>AppAudit: Guardian + Monitor</title>
  <link rel="manifest" href="manifest.json">
<style>
  :root { --accent: #ff9f43; --bg: #121212; --panel: #1e1e1e; --text: #eee; --success: #1dd1a1; --warn: #feca57; }
  body { background: var(--bg); color: var(--text); font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
  header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  h1 { margin: 0; font-size: 18px; color: var(--accent); }
  #container { flex: 1; overflow-y: auto; padding: 15px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; }
  .section { display: flex; flex-direction: column; gap: 10px; }
  .hidden { display: none !important; }
  textarea { background: #161616; color: #dcdcdc; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 12px; min-height: 380px; width: 100%; box-sizing: border-box; outline: none; }
  .btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .btn-primary { background: var(--accent); color: #000; }
  #status-deck { display: none; background: #000; border: 1px solid #333; border-radius: 8px; padding: 20px; font-size: 14px; text-align: center; }
  .issue-card { background: #222; padding: 12px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 5px; }
  #fix-result { background: #000; padding: 15px; font-size: 12px; color: #a29bfe; white-space: pre; overflow-x: auto; min-height: 380px; border: 1px solid #333; border-radius: 8px; }
</style>
</head>
<body>

<header>
    <h1>AppAudit <span style="font-size:10px">GUARDIAN + MONITOR</span></h1>
    <button onclick="document.getElementById('settings').style.display='flex'" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
</header>

<div id="container">
    <div id="sec-input" class="section">
        <label>1. Input Source Code</label>
        <textarea id="code-in" placeholder="// Paste code here..."></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="startAnalysis()" class="btn btn-primary" style="flex:2">üîç ANALYZE</button>
            <button onclick="forceErase()" class="btn" style="background:#ee5253; color:white; flex:1">üóëÔ∏è CLEAR</button>
        </div>
    </div>

    <div id="status-deck"></div>

    <div id="sec-list" class="section hidden">
        <label>2. Issues Detected</label>
        <div id="issue-list"></div>
        <div style="padding:15px; background:var(--panel); border-radius:12px; display:flex; flex-direction:column; gap:10px;">
            <input type="text" id="target-issue" style="padding:10px; background:#111; color:white; border:1px solid #444;" placeholder="Issue IDs (e.g. 1, 2)">
            <button onclick="fixIssues()" id="btn-fix" class="btn btn-primary">‚ú® APPLY PRECISION PATCHES</button>
            <button onclick="goBack()" style="background:none; border:none; color:#888;">BACK</button>
        </div>
    </div>

    <div id="sec-result" class="section hidden">
        <label>3. Patched Source Code</label>
        <div id="fix-result"></div>
        <button onclick="copyFix()" class="btn btn-primary" style="margin-top:10px">üìã COPY PATCHED CODE</button>
        <button onclick="goBack()" class="btn" style="background:#333; color:white; margin-top:10px">START OVER</button>
    </div>
</div>

<div id="settings" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center;">
    <div style="background:#222; padding:20px; border-radius:12px; width:300px; display:flex; flex-direction:column; gap:10px;">
        <h3 style="color:white; margin:0">Settings</h3>
        <input type="password" id="api-key" placeholder="Gemini API Key" style="padding:10px;">
        <button onclick="saveKey()" class="btn btn-primary">Save Key</button>
    </div>
</div>

<script>
const MODEL = "gemini-2.5-flash"; 
let apiKey = localStorage.getItem('helix_google_key') || "";
let currentCode = "";
let issues = [];
let lastCodeHash = ""; // For the Monitor

function forceErase() {
    document.getElementById('code-in').value = "";
    document.getElementById('code-in').focus();
    currentCode = "";
}

function saveKey() {
    apiKey = document.getElementById('api-key').value.trim();
    localStorage.setItem('helix_google_key', apiKey);
    document.getElementById('settings').style.display = 'none';
}

function goBack() {
    document.getElementById('sec-input').classList.remove('hidden');
    document.getElementById('sec-list').classList.add('hidden');
    document.getElementById('sec-result').classList.add('hidden');
    document.getElementById('status-deck').style.display = 'none';
}

async function callGemini(prompt, isFix = false) {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: isFix ? 0 : 0.1, maxOutputTokens: 8192 }
        })
    });
    const json = await response.json();
    return json.candidates[0].content.parts[0].text;
}

async function startAnalysis() {
    currentCode = document.getElementById('code-in').value.trim();
    if(!currentCode) return;

    // Monitor: Check if code has changed since last time
    let currentHash = currentCode.length + currentCode.substring(0, 30);
    
    document.getElementById('sec-input').classList.add('hidden');
    const statusDeck = document.getElementById('status-deck');
    statusDeck.style.display = 'block';
    statusDeck.innerHTML = '<span style="color:var(--accent)">> Running Audit Engine...</span>';

    const prompt = `Return ONLY a JSON array. If no issues, return []. Format: [{"id":1,"severity":"high","title":"X","desc":"Y"}] \n\n CODE: \n ${currentCode}`;
    
    try {
        const res = await callGemini(prompt);
        const match = res.match(/\[\s*[\s\S]*\s*\]/);
        
        if(match) {
            issues = JSON.parse(match[0]);
            
            // --- MONITOR LOGIC ---
            const onlyMinor = issues.every(i => i.severity.toLowerCase() === 'low' || i.severity.toLowerCase() === 'info');

            if (issues.length === 0) {
                statusDeck.innerHTML = "<div style='color:var(--success); font-size:18px;'>‚úÖ QUALITY GOAL REACHED<br><span style='font-size:12px; color:#aaa;'>Your code is 100% clean. No further action needed.</span></div><button onclick='goBack()' class='btn' style='margin:20px auto 0; background:#333; color:white;'>RETURN</button>";
                return;
            } else if (onlyMinor && currentHash === lastCodeHash) {
                statusDeck.innerHTML = "<div style='color:var(--warn); font-size:18px;'>‚ö†Ô∏è STABILITY REACHED<br><span style='font-size:12px; color:#aaa;'>Only minor stylistic suggestions remain. Re-fixing may break structure.</span></div><button onclick='renderList()' class='btn' style='margin:20px auto 0; background:var(--accent); color:black;'>SHOW MINOR ISSUES ANYWAY</button>";
                return;
            }

            lastCodeHash = currentHash; 
            renderList();
        }
    } catch(e) { statusDeck.innerHTML = "Error: " + e.message; }
}

function renderList() {
    document.getElementById('status-deck').style.display = 'none';
    document.getElementById('sec-list').classList.remove('hidden');
    document.getElementById('issue-list').innerHTML = issues.map(i => `
        <div class="issue-card">
            <span style="font-size:10px; color:var(--accent); text-transform:uppercase;">${i.severity}</span><br>
            <b>${i.id}. ${i.title}</b><br><small>${i.desc}</small>
        </div>`).join('');
}

async function fixIssues() {
    const btn = document.getElementById('btn-fix');
    btn.innerText = "SURGICAL PATCHING...";
    const target = document.getElementById('target-issue').value;
    const tasks = target ? issues.filter(i => target.includes(i.id)) : issues;

    const prompt = `You are a surgical patching engine. Fix issues: ${tasks.map(t=>t.title).join(', ')}. 
    RULES: Return COMPLETE file line-by-line. No placeholders. No markdown. No comments.
    CODE: \n ${currentCode}`;

    try {
        let text = await callGemini(prompt, true);
        text = text.replace(/^```[\s\S]*?\n/g, '').replace(/```$/g, '').trim();
        document.getElementById('fix-result').innerText = text;
        document.getElementById('sec-list').classList.add('hidden');
        document.getElementById('sec-result').classList.remove('hidden');
    } catch(e) { alert("Patch failed."); }
    btn.innerText = "‚ú® APPLY PRECISION PATCHES";
}

function copyFix() {
    navigator.clipboard.writeText(document.getElementById('fix-result').innerText);
    alert("Copied!");
}
</script>
</body>
</html>