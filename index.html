<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>AppAudit: Multi-Fix</title>
<meta name="theme-color" content="#121212">

<style>
  :root { 
    --accent: #ff9f43; 
    --bg: #121212; --panel: #1e1e1e; 
    --text: #eee; --crit: #ff6b6b; --warn: #feca57; --success: #1dd1a1; 
  }
  
  body { background: var(--bg); color: var(--text); font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
  
  /* HEADER */
  header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  h1 { margin: 0; font-size: 18px; color: var(--accent); }
  
  /* CONTAINER */
  #container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
  
  .section { display: flex; flex-direction: column; gap: 10px; }
  .hidden { display: none !important; }
  label { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }

  /* TEXT AREA */
  textarea { background: #161616; color: #dcdcdc; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 12px; min-height: 250px; width: 100%; box-sizing: border-box; outline: none; resize: vertical; white-space: pre; }
  textarea:focus { border-color: var(--accent); }

  /* BUTTONS */
  .btn-row { display: flex; gap: 10px; }
  .btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; color: #fff; display:flex; align-items:center; justify-content:center; }
  .btn-primary { background: var(--accent); color: #000; flex: 2; }
  .btn-danger { background: #ee5253; color: white; flex: 1; }
  .btn-danger:active { background: #ff0000; }
  
  /* STATUS LOG */
  #status-deck { display: none; background: #000; border: 1px solid #333; border-radius: 8px; padding: 15px; height: 150px; overflow-y: auto; font-size: 12px; color: var(--accent); }
  .log-line { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }

  /* ISSUE LIST */
  #issue-list { display: flex; flex-direction: column; gap: 8px; }
  .issue-item { background: var(--panel); padding: 15px; border-radius: 8px; border-left: 4px solid #555; cursor: pointer; display: flex; gap: 10px; transition: 0.2s; }
  .issue-item:active { background: #2d2d2d; }
  .issue-num { font-weight: bold; font-size: 18px; color: var(--accent); min-width: 30px; }
  
  .sev-high { border-left-color: var(--crit); }
  .sev-med { border-left-color: var(--warn); }

  /* FIX BAR */
  #fix-controls { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; position: sticky; bottom: 10px; z-index: 50; }
  
  .fix-inputs { display: flex; gap: 10px; width: 100%; }
  
  input.num-input { background: #111; border: 1px solid #444; color: white; flex:1; padding: 10px; text-align: center; border-radius: 6px; outline: none; font-size:14px; }
  
  /* RESULT BOX */
  .result-box { border: 1px solid #333; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
  .result-header { background: #2d3436; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
  .result-label { font-size: 10px; font-weight: bold; color: #aaa; }
  .copy-btn { background: #0984e3; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; }
  #fix-result { background: #000; padding: 15px; font-family: monospace; font-size: 12px; color: #a29bfe; white-space: pre; overflow-x: auto; min-height: 200px; }

  /* SETTINGS */
  #settings { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center; }
  .box { background: #222; padding: 20px; border-radius: 12px; width: 300px; display: flex; flex-direction: column; gap: 10px; border: 1px solid #444; }
  #api-key { padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; }
</style>
</head>
<body>

<header>
    <h1>AppAudit <span style="font-size:10px">MULTI-FIX</span></h1>
    <button onclick="document.getElementById('settings').style.display='flex'" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
</header>

<div id="container">

    <div id="sec-input" class="section">
        <label>1. Input Code</label>
        <textarea id="code-in" placeholder="// Paste code here..."></textarea>
        <div class="btn-row">
            <button onclick="startAnalysis()" class="btn btn-primary">üîç ANALYZE</button>
            <button onclick="forceErase()" class="btn btn-danger">üóëÔ∏è ERASE</button>
        </div>
    </div>

    <div id="status-deck"></div>

    <div id="sec-list" class="section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <label>2. Detected Issues</label>
            <button onclick="goBack()" style="background:none; border:none; color:#aaa; font-size:10px; cursor:pointer;">‚óÄ BACK</button>
        </div>
        
        <div id="issue-list"></div>
        
        <div id="fix-controls">
            <div class="fix-inputs">
                <input type="text" id="target-issue" class="num-input" placeholder="e.g. 1, 3">
                <button onclick="fixIssues('selected')" id="btn-fix-sel" class="btn btn-primary">‚ú® FIX SELECTED</button>
            </div>
            <button onclick="fixIssues('all')" id="btn-fix-all" class="btn" style="background:#6c5ce7; width:100%">üöÄ FIX EVERYTHING</button>
        </div>
    </div>

    <div id="sec-result" class="section hidden">
        <label>3. Solution</label>
        <div class="result-box">
            <div class="result-header">
                <span class="result-label">GENERATED CODE</span>
                <button onclick="copyFix()" class="copy-btn">üìã COPY ALL</button>
            </div>
            <div id="fix-result"></div>
        </div>
        <button onclick="goBack()" class="btn" style="background:#333; width:100%; margin-top:10px">CLOSE</button>
    </div>

</div>

<div id="settings">
    <div class="box">
        <h3 style="color:white; margin:0">Settings</h3>
        <input type="password" id="api-key" placeholder="Paste Gemini API Key">
        <button onclick="testConnection()" class="btn" style="background:#0984e3">Test Connection</button>
        <button onclick="saveKey()" class="btn btn-primary">Save Key</button>
        <button onclick="document.getElementById('settings').style.display='none'" class="btn" style="background:#333">Close</button>
    </div>
</div>

<script>
// --- CONFIG ---
const MODEL = "gemini-2.5-flash"; 

// --- STATE ---
let apiKey = localStorage.getItem('helix_google_key') || "";
let currentCode = "";
let issues = [];

window.onload = () => { 
    if(!apiKey) document.getElementById('settings').style.display='flex'; 
}

// --- ACTIONS ---

function forceErase() {
    document.getElementById('code-in').value = "";
    document.getElementById('code-in').focus();
}

function goBack() {
    document.getElementById('sec-input').classList.remove('hidden');
    document.getElementById('sec-list').classList.add('hidden');
    document.getElementById('sec-result').classList.add('hidden');
    document.getElementById('status-deck').style.display = 'none';
}

function log(msg) {
    let d = document.createElement('div');
    d.className = 'log-line'; d.innerText = "> " + msg;
    document.getElementById('status-deck').appendChild(d);
}

async function testConnection() {
    let key = document.getElementById('api-key').value.trim();
    if(!key) return alert("Enter key first");
    
    try {
        let r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
        });
        if(r.ok) alert("‚úÖ Connection Successful!");
        else alert("‚ùå Error: " + (await r.json()).error.message);
    } catch(e) { alert("‚ùå Network Error: " + e.message); }
}

async function startAnalysis() {
    currentCode = document.getElementById('code-in').value.trim();
    if(!currentCode) return alert("Paste code first.");
    if(!apiKey) return document.getElementById('settings').style.display='flex';

    document.getElementById('sec-input').classList.add('hidden');
    document.getElementById('status-deck').style.display = 'block';
    document.getElementById('status-deck').innerHTML = '';
    
    log("Connecting to Gemini 2.5...");
    
    // PLAIN ENGLISH PROMPT
    const prompt = `
        You are a friendly Code Teacher. Analyze the code below.
        
        Return ONLY a JSON Array. No other text.
        Format: [{"id": 1, "severity": "high", "title": "Simple Name", "desc": "Explain clearly in Plain English. Why does this matter?"}]
        
        Rank from High to Low severity.
        
        CODE:
        ${currentCode.substring(0, 45000)}
    `;

    try {
        let text = await callGemini(prompt);
        let jsonMatch = text.match(/\[\s*\{[\s\S]*\}\s*\]/);
        if(jsonMatch) {
            issues = JSON.parse(jsonMatch[0]);
            renderList();
            document.getElementById('status-deck').style.display = 'none';
            document.getElementById('sec-list').classList.remove('hidden');
        } else {
            throw new Error("AI returned invalid data.");
        }
    } catch(e) {
        log("ERROR: " + e.message);
        setTimeout(() => { alert("Failed. Check API Key."); goBack(); }, 2000);
    }
}

// --- NEW MULTI-FIX LOGIC ---
async function fixIssues(mode) {
    let tasks = [];
    
    if (mode === 'all') {
        tasks = issues; // Select everything
    } else {
        // Parse input like "1, 3, 5"
        let val = document.getElementById('target-issue').value;
        let ids = val.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        
        if (ids.length === 0) return alert("Enter issue numbers (e.g. 1, 3)");
        
        // Find matching issues
        tasks = issues.filter(i => ids.includes(i.id));
    }

    if (tasks.length === 0) return alert("No valid issues found.");

    // Update button UI
    let btnId = mode === 'all' ? 'btn-fix-all' : 'btn-fix-sel';
    let btn = document.getElementById(btnId);
    let oldText = btn.innerText;
    btn.innerText = "WORKING...";

    // Create a bulleted list of requests for the AI
    let taskList = tasks.map(t => `- Issue #${t.id}: ${t.title}`).join("\n");

    const prompt = `
        You are a Senior Developer.
        Apply fixes for the following issues in the code:
        
        ${taskList}
        
        IMPORTANT: Return the FULL, completely corrected code block. Do not truncate.
        
        Original Code:
        ${currentCode}
    `;

    try {
        let text = await callGemini(prompt);
        text = text.replace(/```(\w*)/, '').replace(/```$/, '').trim();
        document.getElementById('fix-result').innerText = text;
        document.getElementById('sec-result').classList.remove('hidden');
        document.getElementById('fix-result').scrollIntoView({behavior: "smooth"});
    } catch(e) { alert("Fix failed."); }
    
    btn.innerText = oldText;
}

async function callGemini(prompt) {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    if(!response.ok) throw new Error((await response.json()).error.message);
    const json = await response.json();
    return json.candidates[0].content.parts[0].text;
}

// --- RENDER ---
function renderList() {
    let list = document.getElementById('issue-list');
    list.innerHTML = issues.map(i => {
        let color = i.severity.includes('high') ? 'sev-high' : 'sev-med';
        return `
            <div class="issue-item ${color}" onclick="addNumberToInput(${i.id})">
                <div class="issue-num">${i.id}</div>
                <div style="flex:1">
                    <span style="font-weight:bold; display:block">${i.title}</span>
                    <span style="font-size:13px; color:#ccc; line-height:1.4">${i.desc}</span>
                </div>
            </div>
        `;
    }).join('');
    
    // Auto-fill first number
    if(issues.length > 0) document.getElementById('target-issue').value = issues[0].id;
}

// Helper: Tapping a list item adds/toggles its number in the input box
function addNumberToInput(id) {
    let input = document.getElementById('target-issue');
    let current = input.value.split(',').map(n => n.trim()).filter(n => n);
    
    if(!current.includes(String(id))) {
        current.push(id);
        input.value = current.join(', ');
    }
}

function saveKey() {
    apiKey = document.getElementById('api-key').value.trim();
    localStorage.setItem('helix_google_key', apiKey);
    document.getElementById('settings').style.display = 'none';
}

function copyFix() {
    let text = document.getElementById('fix-result').innerText;
    navigator.clipboard.writeText(text);
    
    let btn = document.querySelector('.copy-btn');
    let oldText = btn.innerText;
    btn.innerText = "COPIED!";
    setTimeout(() => btn.innerText = oldText, 2000);
}
</script>
</body>
</html>
