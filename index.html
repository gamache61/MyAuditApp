<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://generativelanguage.googleapis.com;">
  <title>AppAudit: Guardian 4.9.2 (2.5 Flash Auto-Fix)</title>
  <style>
    :root { --accent: #ff9f43; --bg: #0f0f0f; --panel: #1e1e1e; --text: #eee; --success: #1dd1a1; --warn: #feca57; --error: #ff6b6b; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
    header { padding: 15px 25px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 18px; color: var(--accent); letter-spacing: 1px; }
    .stat-pill { background: #333; padding: 4px 10px; border-radius: 20px; font-size: 10px; color: var(--accent); font-weight: bold; border: 1px solid #444; }
    #container { flex: 1; overflow-y: auto; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; }
    .section { display: flex; flex-direction: column; gap: 12px; animation: fadeIn 0.3s ease; }
    .hidden { display: none !important; }
    textarea, #fix-result { background: #161616; color: #dcdcdc; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: 'Consolas', monospace; font-size: 13px; min-height: 300px; width: 100%; box-sizing: border-box; outline: none; line-height: 1.5; resize: none; }
    #fix-result { border-color: var(--success); color: #a29bfe; white-space: pre; overflow-x: auto; }
    .issue-card { background: #252525; padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent); margin-bottom: 8px; font-size: 13px; }
    .btn-primary { background: var(--accent); color: #000; font-weight: bold; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-secondary { background: #333; color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
    #debug-wrapper { border-top: 1px solid #333; padding: 15px; background: #000; }
    #debug-log { color: #0f0; font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto; white-space: pre-wrap; }
    .loader { width: 16px; height: 16px; border: 2px solid #333; border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<header>
    <h1>AppAudit <span style="font-size:10px; opacity:0.7;">2.5-FLASH AUTO-FIX</span></h1>
    <div style="display:flex; gap:10px; align-items:center;">
        <div id="request-count" class="stat-pill">QUERIES: 0</div>
        <button id="settings-btn" style="background:none; border:none; cursor:pointer;">‚öôÔ∏è</button>
    </div>
</header>

<div id="container">
    <div id="sec-input" class="section">
        <label style="color: #888; font-weight: bold;">[01] SOURCE_CODE_INPUT</label>
        <textarea id="code-in" placeholder="// Paste code to Audit & Fix..."></textarea>
        <div style="display: flex; gap: 10px;">
            <button id="btn-run" class="btn-primary" style="flex: 2;">üîç AUDIT & AUTO-FIX</button>
            <button id="btn-erase" class="btn-secondary" style="flex: 1;">üóëÔ∏è ERASE</button>
        </div>
    </div>

    <div id="status-deck" style="display:none; text-align:center; padding:40px; background:#1a1a1a; border-radius:8px;"></div>

    <div id="sec-result" class="section hidden">
        <label style="color: var(--success); font-weight: bold;">[02] REPAIRED_OUTPUT</label>
        <div id="fix-result"></div>
        <div style="display: flex; gap: 10px;">
            <button id="btn-copy" class="btn-primary" style="flex: 1;">üìã COPY REPAIRED CODE</button>
            <button id="btn-new" class="btn-secondary" style="flex: 1;">NEW PROJECT</button>
        </div>
        <div id="patch-report-container">
            <h4 style="color:var(--accent); margin-bottom: 10px;">PATCH REPORT:</h4>
            <div id="patch-notes"></div>
        </div>
    </div>

    <div id="debug-wrapper">
        <div id="debug-log">> SYSTEM: GEMINI-2.5-FLASH STABILIZED.</div>
    </div>
</div>

<div id="settings-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center;">
    <div style="background:#222; padding:30px; border-radius:12px; border:1px solid var(--accent); width: 320px; display: flex; flex-direction: column; gap: 15px;">
        <h3 style="margin:0; color:white;">Authorization</h3>
        <input type="password" id="api-key-input" placeholder="Enter Gemini API Key" style="padding:12px; background:#111; color:white; border:1px solid #444;">
        <button id="btn-save-key" class="btn-primary">SAVE KEY</button>
        <button id="btn-close-settings" class="btn-secondary">Close</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const MODEL = "gemini-2.5-flash"; 
    let queryCount = 0;
    let sessionKey = localStorage.getItem('appaudit_key') || "";
    if (sessionKey) document.getElementById('api-key-input').value = sessionKey;

    const el = {
        input: document.getElementById('code-in'),
        inputSec: document.getElementById('sec-input'),
        resultSec: document.getElementById('sec-result'),
        status: document.getElementById('status-deck'),
        fixResult: document.getElementById('fix-result'),
        patchNotes: document.getElementById('patch-notes'),
        debug: document.getElementById('debug-log'),
        settings: document.getElementById('settings-modal'),
        keyIn: document.getElementById('api-key-input'),
        counter: document.getElementById('request-count')
    };

    function log(msg, isError = false) {
        const div = document.createElement('div');
        div.style.color = isError ? 'var(--error)' : '#0f0';
        div.textContent = `> ${msg}`;
        el.debug.appendChild(div);
        el.debug.scrollTop = el.debug.scrollHeight;
    }

    async function callEngine(prompt) {
        if (!sessionKey) { el.settings.style.display = 'flex'; throw new Error("API Key Missing"); }
        queryCount++;
        el.counter.innerText = `QUERIES: ${queryCount}`;
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${sessionKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

        const json = await response.json();
        if (!response.ok) throw new Error(json.error?.message || "API_ERROR");
        return json.candidates[0].content.parts[0].text;
    }

    async function startProcess() {
        const currentCode = el.input.value.trim();
        if (!currentCode) return;
        
        el.inputSec.classList.add('hidden');
        el.status.style.display = 'block';
        el.status.innerHTML = '<div class="loader"></div> 2.5 FLASH: ANALYZING & REPAIRING...';
        
        try {
            const prompt = `Perform a security audit and repair. 
            Return a JSON object ONLY: 
            {
              "fixedCode": "the full repaired code",
              "audit": [{"title": "Vulnerability Name", "plain": "Short explanation", "severity": "High|Low"}]
            }
            Target Code: ${currentCode}`;

            const raw = await callEngine(prompt);
            const cleaned = raw.replace(/```json/g, '').replace(/```/g, '').trim();
            const data = JSON.parse(cleaned.substring(cleaned.indexOf('{'), cleaned.lastIndexOf('}') + 1));
            
            // Render Result
            el.fixResult.textContent = data.fixedCode;
            el.patchNotes.innerHTML = data.audit.map(i => `
                <div class="issue-card" style="border-left-color: ${i.severity === 'High' ? 'var(--error)' : 'var(--warn)'}">
                    <b>${i.title}</b>: ${i.plain}
                </div>`).join('');
            
            el.status.style.display = 'none';
            el.resultSec.classList.remove('hidden');
            log("AUTO-FIX SUCCESSFUL.");
        } catch (e) { 
            log(`CRITICAL: ${e.message}`, true);
            el.status.innerHTML = `<div style="color:var(--error)">Process Failed: ${e.message}</div><button onclick="location.reload()" class="btn-secondary" style="margin-top:10px;">RETRY</button>`;
        }
    }

    // Bindings
    document.getElementById('btn-run').onclick = startProcess;
    document.getElementById('btn-erase').onclick = () => el.input.value = "";
    document.getElementById('btn-save-key').onclick = () => { 
        sessionKey = el.keyIn.value.trim(); 
        localStorage.setItem('appaudit_key', sessionKey); 
        el.settings.style.display = 'none'; 
        log("KEY UPDATED."); 
    };
    document.getElementById('settings-btn').onclick = () => el.settings.style.display = 'flex';
    document.getElementById('btn-close-settings').onclick = () => el.settings.style.display = 'none';
    document.getElementById('btn-new').onclick = () => location.reload();
    document.getElementById('btn-copy').onclick = () => {
        navigator.clipboard.writeText(el.fixResult.textContent);
        log("REPAIRED CODE COPIED.");
    };
});
</script>
</body>
</html>
