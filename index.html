<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="Professional HTML structural and accessibility auditor powered by Gemini 2.5 Flash.">
  <title>MyAuditApp</title>
  <link rel="manifest" href="./manifest.json">
  <style>
    :root {
      --accent: #ff9f43; --bg: #0f0f0f; --text: #eee; --success: #1dd1a1;
      --error: #ff6b6b; --header-bg: #1a1a1a; --card-bg: #252525;
      --input-bg: #161616; --border-color: #333; --modal-bg: #222;
    }
    body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
    header { padding: 15px 25px; background: var(--header-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 18px; color: var(--accent); }
    .model-badge { font-size: 11px; background: var(--border-color); color: var(--accent); padding: 4px 8px; border-radius: 4px; margin-left: 10px; }
    #container { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; }
    .hidden { display: none !important; }
    textarea, #fix-result { background: var(--input-bg); color: #dcdcdc; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 13px; min-height: 350px; width: 100%; outline: none; line-height: 1.5; resize: vertical; }
    #fix-result { white-space: pre-wrap; overflow-x: auto; }
    .issue-card { background: var(--card-bg); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 10px; }
    .btn-primary { background: var(--accent); color: #000; font-weight: bold; padding: 14px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary:disabled { background: #555; cursor: not-allowed; }
    .btn-secondary { background: var(--border-color); color: var(--text); padding: 14px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-icon { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--text); padding: 0; }
    .loader { width: 18px; height: 18px; border: 2px solid var(--border-color); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status-deck { display: none; text-align: center; padding: 20px; }
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; }
    .modal-content { background: var(--modal-bg); padding: 30px; border-radius: 12px; width: 300px; display: flex; flex-direction: column; gap: 15px; border: 1px solid var(--accent); }
    .modal-input { padding: 10px; background: var(--input-bg); color: var(--text); border: 1px solid #444; border-radius: 4px; }
    .button-group { display: flex; gap: 10px; }
    .button-group .btn-primary { flex: 2; }
    .button-group .btn-secondary { flex: 1; }
  </style>
</head>
<body>

<header>
    <h1>MyAuditApp <span class="model-badge">Gemini 2.5 Flash</span></h1>
    <button id="settings-btn" class="btn-icon" aria-label="Settings">‚öôÔ∏è</button>
</header>

<div id="container">
    <div id="sec-input" class="section">
        <textarea id="code-in" placeholder="Paste HTML here..."></textarea>
        <div class="button-group">
            <button id="btn-analyze" class="btn-primary">üîç ANALYZE CODE</button>
            <button id="btn-erase" class="btn-secondary">üóëÔ∏è ERASE</button>
        </div>
    </div>
    <div id="status-deck" class="status-deck" role="status" aria-live="polite"></div>
    <div id="sec-list" class="section hidden">
        <div id="issue-list"></div>
        <div class="button-group">
            <button id="btn-fix-action" class="btn-primary">‚ú® APPLY REPAIRS</button>
            <button id="btn-cancel" class="btn-secondary">CANCEL</button>
        </div>
    </div>
    <div id="sec-result" class="section hidden">
        <div id="fix-result"></div>
        <div class="button-group">
            <button id="btn-copy" class="btn-primary">üìã COPY FIXED CODE</button>
            <button id="btn-new" class="btn-secondary">START NEW</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <input type="password" id="api-key-input" class="modal-input" placeholder="Gemini API Key" aria-label="Gemini API Key">
        <button id="btn-save-key" class="btn-primary">SAVE KEY</button>
        <button id="btn-close-settings" class="btn-secondary">CLOSE</button>
    </div>
</div>

<script>
// Relative Registration for GitHub Pages
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js', { scope: './' })
      .then(reg => console.log('SW Registered'))
      .catch(err => console.log('SW Failed', err));
  });
}

document.addEventListener('DOMContentLoaded', function() {
    const MODEL = "gemini-2.5-flash";
    const TEMP = 0.1;
    let sessionKey = localStorage.getItem('appaudit_key') || "";

    const el = {
        input: document.getElementById('code-in'),
        listSec: document.getElementById('sec-list'),
        inputSec: document.getElementById('sec-input'),
        resultSec: document.getElementById('sec-result'),
        status: document.getElementById('status-deck'),
        issueList: document.getElementById('issue-list'),
        fixResult: document.getElementById('fix-result'),
        settingsModal: document.getElementById('settings-modal'),
        apiKeyInput: document.getElementById('api-key-input'),
        btnAnalyze: document.getElementById('btn-analyze'),
        btnFixAction: document.getElementById('btn-fix-action'),
        settingsBtn: document.getElementById('settings-btn')
    };

    function resetUI() { el.inputSec.classList.remove('hidden'); el.listSec.classList.add('hidden'); el.resultSec.classList.add('hidden'); el.status.style.display = 'none'; el.btnFixAction.innerHTML = '‚ú® APPLY REPAIRS'; el.btnFixAction.disabled = false; }

    async function callEngine(prompt) {
        if (!sessionKey) { el.settingsModal.style.display = 'flex'; throw new Error("Key Missing"); }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${sessionKey}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: TEMP } })
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error?.message || "API Error");
        return json.candidates[0].content.parts[0].text;
    }

    el.btnAnalyze.onclick = async () => {
        const code = el.input.value.trim();
        if (!code) return;
        el.inputSec.classList.add('hidden');
        el.status.style.display = 'flex';
        el.status.innerHTML = '<div class="loader"></div> SCANNING...';
        try {
            const prompt = `Task: Structural Audit. Output: Valid JSON Array ONLY. Code: ${code}`;
            let raw = await callEngine(prompt);
            const match = raw.match(/\[[\s\S]*\]/);
            if (!match) {
                el.status.innerHTML = '<b style="color:var(--success)">‚úì CODE HEALTHY</b><br><button id="btn-back" class="btn-secondary" style="margin-top:10px;">BACK</button>';
                document.getElementById('btn-back').onclick = resetUI;
                return;
            }
            const issues = JSON.parse(match[0]);
            el.status.style.display = 'none';
            el.listSec.classList.remove('hidden');
            el.issueList.innerHTML = issues.map(i => `<div class="issue-card"><b>${i.title}</b><p>${i.plain}</p></div>`).join('');
        } catch (e) { alert("Error: " + e.message); resetUI(); }
    };

    el.btnFixAction.onclick = async () => {
        const original = el.input.value.trim();
        el.btnFixAction.innerHTML = '<div class="loader"></div> REPAIRING...';
        el.btnFixAction.disabled = true;
        try {
            const prompt = `Rewrite this code. Fix errors. Output ONLY code. Code: ${original}`;
            let res = await callEngine(prompt);
            res = res.replace(/^```[a-z]*\n/i, '').replace(/\n```$/i, '').trim();
            el.fixResult.textContent = res;
            el.listSec.classList.add('hidden');
            el.resultSec.classList.remove('hidden');
        } catch (e) { alert(e.message); }
        finally { el.btnFixAction.innerHTML = '‚ú® APPLY REPAIRS'; el.btnFixAction.disabled = false; }
    };

    document.getElementById('btn-erase').onclick = () => el.input.value = "";
    document.getElementById('btn-new').onclick = () => { el.input.value = ""; resetUI(); };
    document.getElementById('btn-cancel').onclick = resetUI;
    document.getElementById('btn-save-key').onclick = () => { sessionKey = el.apiKeyInput.value.trim(); localStorage.setItem('appaudit_key', sessionKey); el.settingsModal.style.display = 'none'; };
    el.settingsBtn.onclick = () => el.settingsModal.style.display = 'flex';
    document.getElementById('btn-close-settings').onclick = () => el.settingsModal.style.display = 'none';
    document.getElementById('btn-copy').onclick = () => { navigator.clipboard.writeText(el.fixResult.textContent); alert("Copied!"); };
});
</script>
</body>
</html>